<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Registro de Residentes :: SIGER</title>
        <link rel="stylesheet" href="styles/global.css" />
        <link rel="stylesheet" href="styles/forms.css">
        <style>
            .form-input {
                display: flex;
                padding: 1em;
                align-items: center;
            }

            .form-input > * {
                flex: 3;
            }

            .form-input > label {
                flex: 1;
            }

            .button-container {
                display: flex;
                justify-content: center;
                margin-top: 2em;
            }
            
        </style>
    </head>
    <body>
        <header class="header-extension">
            <div class="bar">
                <!-- <h1><a href="/home">SIGER</a></h1> -->
                <a href="/home" style="display: flex; flex-direction: row; align-items: center;">
                <img src="assets/images/siger-img.png" height="40px" alt="SIGER">
                <h1 style="margin-left: .5em;">SIGER</h1>
            </a>
                <h2>Registro de estudiantes como Residentes</h2>
            </div>
        </header>

        <div class="content">
            <form id="form">
                <h3>Configuración de cuenta</h3>
                <p>
                    Información requerida para la identificación del residente
                </p>
                <div class="form-input">
                    <label>Correo electrónico*</label>
                    <input
                        type="email"
                        placeholder="L16430123@piedrasnegras.tecnm.mx"
                        name="email"
                        id="emailView"
                        pattern="[L|l][0-9]{8}@piedrasnegras.tecnm.mx"
                        required="required"
                    />
                </div>
                <div class="form-input">
                    <label>Contraseña*</label>
                    <input
                        type="password"
                        placeholder="Mínimo 8 caracteres"
                        name="pass"
                        id="passView"
                        required="required"
                        pattern=".{8,}"
                    />
                </div>
                <div class="form-input">
                    <label>Vuelva a introducir su contraseña*</label>
                    <input
                        type="password"
                        placeholder="Repita la contraseña anterior"
                        required="required"
                        id="repeatPassView"
                        pattern=".{8,}"
                    />
                </div>
                <hr />
                <h3>Configuración del perfil</h3>
                <p>Información del residente</p>
                <div class="form-input">
                    <label>Nombre(s)*</label>
                    <input type="text" name="name" id="nameView" required="required"/>
                </div>
                <div class="form-input">
                    <label>Apellido Paterno*</label>
                    <input
                        type="text"
                        name="patSurname"
                        id="patSurnameView"
                        required="required"
                    />
                </div>
                <div class="form-input">
                    <label>Apellido Materno</label>
                    <input
                        type="text"
                        name="matSurname"
                        id="matSurnameView"
                    />
                </div>
                <div class="form-input">
                    <label>Carrera*</label>
                    <select name="career" id="careerView" required="required">
                        <option value="">Escoja una carrera</option>
                    </select>
                </div>
                
                <div class="form-input">
                    <label>Número de teléfono celular*</label>
                    <input type="tel" pattern="[0-9]{10}|([0-9]{3}-[0-9]{4}-[0-9]{3})" required="required" name="cellNumber" id="cellNumberView">
                </div>
                <div class="form-input">
                    <label>Número de teléfono fijo*</label>
                    <input type="tel" pattern="[0-9]{10}|([0-9]{3}-[0-9]{4}-[0-9]{3})" required="required" name="phoneNumber" id="phoneNumberView">
                </div>
                <div class="button-container">
                    <button type="button" id="submitButtonView" class="primary-button">TERMINAR</button>
                </div>
            </form>
        </div>

        <footer>
            <div class="sections-container">
                <section>
                    <h2>Integrantes</h2>
                    <div class="section-item">
                        <p>Daniel Hernández Sánchez</p>
                        <p><u>L17430048@piedrasnegras.tecnm.mx</u></p>
                    </div>
                    <div class="section-item">
                        <p>Roberto Carlos Díaz Sánchez</p>
                        <p><u>L17430057@piedrasnegras.tecnm.mx</u></p>
                    </div>
                </section>
                <section>
                    <h2>Materias</h2>
                    <div class="section-item">
                        <p>Administración de Bases de Datos</p>
                        <p>SCB-1001</p>
                    </div>
                    <div class="section-item">
                        <p>Ingeniería de Software</p>
                        <p>SCD-1011</p>
                    </div>
                    <div class="section-item">
                        <p>Programación Web</p>
                        <p>AEB-1055</p>
                    </div>
                </section>
                <section>
                    <h2>Enlaces de interés</h2>
                    <div class="section-item">
                        <p>
                            <a href="https://github.com/RobertoCDiaz/SIGER">Repositorio en GitHub</a>
                        </p>
                        <p>
                            <a href="https://piedrasnegrastecnm-my.sharepoint.com/personal/l17430048_piedrasnegras_tecnm_mx/_layouts/15/onedrive.aspx?id=%2Fpersonal%2Fl17430048%5Fpiedrasnegras%5Ftecnm%5Fmx%2FDocuments%2FSIGER&ct=1584840570611&or=OWA-NT&cid=e859c527-8ba0-dede-716d-3772606a50e4&originalPath=aHR0cHM6Ly9waWVkcmFzbmVncmFzdGVjbm0tbXkuc2hhcmVwb2ludC5jb20vOmY6L2cvcGVyc29uYWwvbDE3NDMwMDQ4X3BpZWRyYXNuZWdyYXNfdGVjbm1fbXgvRXVYOUhKWktkM3BEbWZaZ1o0bkMxVmtCejlvODY1TVpqWFdJU3BYd0liNWZlQT9ydGltZT1mc3F4ZUFETzEwZw">
                                Documentación y evidencias
                            </a>
                        </p>
                    </div>
                </section>
            </div>
            <p>Instituto Tecnológico de Piedras Negras</p>
            <p>Ingeniería en Sistemas Computacionales</p>
        </footer>
        <script>
            const emailView = document.getElementById('emailView');
            const passView = document.getElementById('passView');
            const repeatPassView = document.getElementById('repeatPassView');
            const nameView = document.getElementById('nameView');
            const patSurnameView = document.getElementById('patSurnameView');
            const matSurnameView = document.getElementById('matSurnameView');
            const careerView = document.getElementById('careerView');
            const cellNumberView = document.getElementById('cellNumberView');
            const phoneNumberView = document.getElementById('phoneNumberView');

            const fill = () => {
                emailView.value = 'L17430057@piedrasnegras.tecnm.mx';;
                passView.value = 'Rcds161198*';
                repeatPassView.value = 'Rcds161198*';
                nameView.value = "Roberto Carlos";
                patSurnameView.value = 'Díaz';
                matSurnameView.value = 'Sánchez';
                cellNumberView.value = '8781097283';
                phoneNumberView.value = '8787958068';
            }

            const submitButtonView = document.getElementById('submitButtonView');

            const optionView = (key, name) => `<option value="${key}">${name}</option>`;

            const getCareers = () => {
                let xhr = new XMLHttpRequest();
                xhr.open('get', `/listaSimpleDeCarreras`, true);
                xhr.onload = () => {
                    let response = JSON.parse(xhr.responseText).object;
                    
                    for (let i = 0; i < response.length; ++i) {
                        let c = response[i];
                        careerView.innerHTML += optionView(c['clave'], c['nombre_carrera']);
                    }
                }
                xhr.send();
            }

            getCareers();

            submitButtonView.onclick = () => {
                // Validaciones.
                if (
                    emailView.value.trim() == "" ||
                    passView.value == "" ||
                    nameView.value.trim() == "" ||
                    patSurnameView.value.trim() == "" ||
                    careerView.value.trim() == "0" ||
                    cellNumberView.value.trim() == "" ||
                    phoneNumberView.value.trim() == ""
                ) {
                    alert("Por favor, llene todos los campos obligatorios (marcados con un asterisco).");
                    return;
                }

                if (!(new RegExp("[L|l][0-9]{8}@piedrasnegras.tecnm.mx").test(emailView.value.trim()))) {
                    alert("El email no tiene la estructura correcta. Ejemplo: L16430123@piedrasnegras.tecnm.mx")
                    return;
                }

                if (
                    !(new RegExp("[0-9]{10}|([0-9]{3}-[0-9]{4}-[0-9]{3})").test(cellNumberView.value.trim())) ||
                    !(new RegExp("[0-9]{10}|([0-9]{3}-[0-9]{4}-[0-9]{3})").test(phoneNumberView.value.trim()))
                ) {
                    alert("Por favor, introduzca un número de teléfono válido.");
                    return;
                }


                if (passView.value != repeatPassView.value) {
                    alert("Las contraseñas no coinciden.");
                    return;
                }

                // Registro de residente.
                let xhr = new XMLHttpRequest();

                xhr.open('POST', '/registrarResidente', true);
                xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

                xhr.onload = () => {
                    let res = JSON.parse(xhr.responseText);
                    console.log(res);

                    if (res['code'] == 0) {
                        alert('Ha ocurrido un error en el registro, por favor, revise todos los campos e inténtelo de nuevo.');
                        return;
                    }

                    if (res['code'] == -2) {
                        alert(`Ha ocurrido un error: ${res['message']}.`);
                        return;
                    }

                    if (res['code'] == 1) {
                        window.open('/', '_self');
                    }
                }

                xhr.send(
                    `email=${encodeURI(emailView.value.trim())}&` +
                    `pass=${encodeURI(passView.value)}&` +
                    `name=${encodeURI(nameView.value.trim())}&` +
                    `patSurname=${encodeURI(patSurnameView.value.trim())}&` +
                    `matSurname=${encodeURI(matSurnameView.value.trim())}&` +
                    `career=${encodeURI(careerView.value.trim())}&` +
                    `cellNumber=${encodeURI(cellNumberView.value.trim())}&` +
                    `phoneNumber=${encodeURI(phoneNumberView.value.trim())}`
                );
            };
        </script>
    </body>
</html>
